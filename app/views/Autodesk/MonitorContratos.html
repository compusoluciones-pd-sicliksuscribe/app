<div ng-app="myApp" ng-controller="MonitorContratosController">
    <div class="container" ng-swipe-right="" ng-swipe-left="">


        <div class="form-group row">
            <div class="col-xs-12 col-sm-12 col-md-8 col-lg-8">
                <h2 style="float:left;">Monitor de contratos <i class="fa fa-question-circle tourButton" style="float:right; font-size:12px; margin-top:10px; margin-left:10px;" ng-click="IniciarTourMonitor();"></i></h2>
            </div>
            <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
                <br/>
                <label for="Cliente">Clientes:</label>
                <select id="IdEmpresaUsuarioFinal" name="IdEmpresaUsuarioFinal" class="form-control selectOption" ng-model="EmpresaSelect" ng-options="Empresa.csn as Empresa.NombreEmpresa for Empresa in selectEmpresas" ng-change="ActualizarMonitor();" ng-show="SessionCookie.IdTipoAcceso == 2 || SessionCookie.IdTipoAcceso == 10">
                    <option ng-selected="true" value="">Selecciona un cliente</option>
                </select>
            </div>
        </div>
    
        <br>
        <div ng-show="vacio === 0 && EmpresaSelect != ''">
            <h4>Aún no cuentas con suscripciones o servicios... </h4>
        </div>
        
        <!-- Detalle pedidos Autodesk -->
        <div  ng-repeat="pedido in Pedidos | filter:PedidoFilter" style="margin-top: 50px;">
            <div class="row">
                <div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
                    <ul style="list-style-type:none; padding:0%">
                        <li ng-if="pedido.contract_number"> <label for="Contrato">Número de contrato: </label> {{ pedido.contract_number }} </li>
                        <li> <label for="Esquema">Esquema de renovación: </label> {{ pedido.esquemaRenovacion }} </li>
                        <li> <label for="FechaInicio">Duración del contrato: </label> {{ pedido.contract_start_date | date:'d/MM/yyyy' }} <label>-</label> {{ pedido.contract_end_date | date:'d/MM/yyyy' }} </li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-2 col-md-6 col-lg-6">
                    <button id="ActualizarEsquema" class="pull-right btn btn-monitor-pedidos-x-cliente" style="margin-right: .5em; padding: .8em ; min-width: 150px;"
                    ng-click="actualizarEsquema(pedido.NumeroContrato, pedido.Detalles, pedido.IdEsquemaRenovacion)">
                        {{pedido.etiquetaTermSwitch}}
                    </button>
                    <button id="TradeIn" class="pull-right btn btn-monitor-pedidos-x-cliente"
                    data-toggle="modal" data-target="#renovacionTradeIn"
                    ng-click="agregarInfoTradein(pedido);">
                        Trade in
                    </button>
                    <button id="Extender" class="pull-right btn btn-monitor-pedidos-x-cliente"
                    ng-click="getEndDateContract(pedido.IdContrato, pedido.EstatusPedido);">
                        Extender
                    </button>
                    <button id="Renovar" class="pull-right btn btn-monitor-pedidos-x-cliente"
                    data-toggle="modal" data-target="#renovarModal"
                    ng-click="AgregarContrato(pedido);">
                        Renovar
                    </button>
                </div> 
            </div>
    
            <table class="table table-hover table-responsive border-left-right-cero">
                <tr ng-repeat="subscription in pedido.subscriptions" class="repeat-animation">
                    <td>
    
                        <div class="form-group col-xs-12 col-sm-12 col-md-4 col-lg-4">
                            <h4><b>{{ subscription.description }}</b></h4>
                            <ul style="list-style-type:none; padding:0%">
                                <li> <label for="Serie">Número de serie:</label> {{ subscription.subscription_reference_number }} </li>
                                <li> <label for="TipoProducto">Tipo de producto:</label> {{ subscription.subscription_type }} </li>
                                <li ng-if="detalles.IdEstatusPedido === 2"> <label for="Estatus">Estatus pedido: </label> Pago pendiente </li>
                                <li ng-if="detalles.IdEstatusPedido === 3"> <label for="Estatus">Estatus pedido: </label> Pagado </li>
                                <li ng-if="detalles.PedidoImportado === 1"> <span style="font-size: 100%; padding-top: .3em;" class="label label-primary">Importado</span>
                                <li ng-hide="pedido.EstatusContrato === 'canceled'" ng-if="pedido.AutoRenovable && detalles.PagoRenovacion"> <label for="EstatusRenovacion">Estatus de renovación:</label> Pagado </li>
                                <li ng-hide="pedido.EstatusContrato === 'canceled'" ng-if="pedido.AutoRenovable && !detalles.PagoRenovacion"> <label for="EstatusRenovacion">Estatus de renovación:</label> Sin renovar </li>
                                <li ng-if="pedido.AutoRenovable && (detalles.Activo) && (SessionCookie.IdTipoAcceso == 2 || SessionCookie.IdTipoAcceso == 3 || SessionCookie.IdTipoAcceso == 10)">
    
                                </li>
                            </ul>
                        </div>
    
                        <div ng-if="detalles.IdTipoProducto !== 3 && (SessionCookie.IdTipoAcceso == 2 || SessionCookie.IdTipoAcceso == 3 || SessionCookie.IdTipoAcceso == 10) "
                             ng-hide="pedido.EstatusContrato === 'canceled' || pedido.EstatusContrato === 'notRenewed'">
                            <div class="form-group col-xs-12 col-sm-12 col-md-2 col-lg-2">
                                <label>Suscripciones: </label> <br>
                                <div style="margin:0; padding:0;" ng-if="detalles.EstatusFabricante !== 'accepted' || pedido.PorActivar || pedido.EstatusContrato !== 'ready'"> {{ subscription.quantity }} </div>
                                
                                <a ng-click="ActualizarCantidad(detalles.IdPedidoDetalle)" style="text-decoration: none" ng-if="detalles.EstatusFabricante === 'accepted' && !pedido.PorActivar && pedido.EstatusContrato === 'ready' &&  pedido.listoRenovar"> {{ detalles.Cantidad }} &nbsp;
                                    <span class="glyphicon glyphicon-triangle-bottom" ng-show="!detalles.MostrarCantidad"></span>
                                    <span class="glyphicon glyphicon-triangle-top" ng-show="detalles.MostrarCantidad"></span>
                                </a>
                                <br/>
                                <div class="row" ng-show="detalles.MostrarCantidad">
                                    <div class="form-group col-xs-6 col-sm-6 col-md-12 col-lg-12">
                                        <label>Actualizar: </label>
                                        <p>El número de suscripciones se verá reflejado en la renovación.</p>
                                    </div>
                                </div>
    
                                <div class="row" ng-show="detalles.MostrarCantidad">
                                    <div class="form-group col-xs-12 col-sm-12 col-md-8 col-lg-8">
                                        <input type="number" class="form-control" ng-model="detalles.CantidadProxima" max="{{ detalles.Cantidad }}" min="1" />
                                    </div>
                                    <div class="form-group col-xs-6 col-sm-6 col-md-2 col-lg-2">
                                        <h4>
                                            <a id="aActualizar" type="submit" title="Guardar" ng-click="ActualizarDetalle(pedido, detalles);" ng-disabled="!frmCantidad.$valid">
                                                <span class="fa fa-floppy-o" style="cursor:pointer"></span>
                                            </a>
                                        </h4>
                                    </div>
                                    <div class="form-group col-xs-6 col-sm-6 col-md-2 col-lg-2" ng-if="!pedido.AutoRenovable">
                                        <h4>
                                            <a id="pCancelar" type="button" title="No renovar" ng-click="CancelarRenovacion(pedido, detalles);" ng-disabled="!frmCantidad.$valid">
                                                <span class="glyphicon glyphicon-trash" style="cursor:pointer"></span>
                                            </a>
                                        </h4>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <div class="form-group col-xs-12 col-sm-12 col-md-2 col-lg-2">
                            <div>
                                <label >Fecha Inicio: </label>
                                <br/> {{ subscription.contract_start_date | date:'d/MM/yyyy' }}
                            </div>
                            <br>
                            <div>
                                <label >Fecha Fin: </label>
                                <br/> {{ subscription.contract_end_date | date:'d/MM/yyyy' }}
                            </div>
                            
    
                            <div ng-if="pedido.AutoRenovable" ng-hide="pedido.EstatusContrato === 'canceled' || pedido.EstatusContrato === 'notRenewed'" >
                                <label>Fecha límite de cancelación: </label>
                                <br/> {{ pedido.FechaCancelacion  }}
                            </div>
                        </div>

                        <div class="form-group col-xs-12 col-sm-12 col-md-4 col-lg-4">
                            <div style="position: relative; left: 75%; ">
                                <label> Renovar: </label> <input type="checkbox" id="pedido.subscription_reference_number" name="renovar" value="pedido.subscription_reference_number">
                            </div>
                        </div>
    
                    </td>
                </tr>
            </table>

            <!--  Modal de Renovacion -->
            <div id="renovarModal" class="modal fade" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="divLoading" data-cargando>
                        <div class=""><img src="images/ripple.svg" /></div>
                    </div>  
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title">Solicitud de renovación</h4>
                        </div>
                        <div class="modal-body">
                            <div class="form-group has-feedback">
                                <label for="Contacto">*Contacto </label>
                                <select name="Renovar" id="Renovar" class="form-control selectOption" ng-model="Renovar.IdUsuarioContacto" ng-options="Contacto.IdUsuario as Contacto.Nombre + ' ('+ Contacto.CorreoElectronico +')' for Contacto in contactos">
                                        <option ng-selected="true" value="">Selecciona un contacto...</option>
                                    </select>
                            </div>
                            <br/>
                            <div class="form-group alert alert-info">
                                <p>
                                    Al dar click en <b>Renovar Contrato</b>, se agregarán al carrito de compras todos los productos que estén incluidos en el contrato con el estatus de <b>Aceptado</b> y con la cantidad de renovaciones
                                    en el campo de <b>Renovación</b>.
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default btn-modal" data-dismiss="modal">Regresar</button>
                            <button type="button" class="btn btn-primary btn-modal" data-dismiss="modal" ng-click="SolicitarRenovacion();">Renovar contrato</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal para trade in -->
            <div id="renovacionTradeIn" class="modal fade" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="divLoading" data-cargando>
                        <div class=""><img src="images/ripple.svg" /></div>
                    </div>  
                    <div class="row modal-content">
                        <div class="col-sm-12 col-md-12 col-lg-12 modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title">Solicitud de renovación trade in</h4>
                        </div>
                        <div class="col-sm-12 col-md-12 col-lg-12 modal-body">
                            <div class="col-sm-6 col-md-6 col-lg-6 form-group has-feedback">
                                <label >Contacto </label>
                                <select class="form-control selectOption" ng-model="tradeIn.IdUsuarioContacto" ng-options="Contacto.IdUsuario as Contacto.Nombre + ' ('+ Contacto.CorreoElectronico +')' for Contacto in contactos">
                                        <option ng-selected="true" value="">Selecciona un contacto...</option>
                                    </select>
                            </div>
                            <br>
                            <br>
                            <div class="col-lg-12 col-md-12 col-sm-12">
                                <div style="text-align: center;">
                                    <label class="col-lg-4 col-md-4 col-sm-4">Numero de serie</label>
                                    <label class="col-lg-3 col-md-3 col-sm-3">Cantidad</label>
                                    <label class="col-lg-3 col-md-3 col-sm-3">Cantidad trade in</label>
                                </div>
                                <div class="row" ng-repeat="detalle in tradeIn.detalles"  style="text-align: center;">
                                    <div class="col-lg-4 col-md-4 col-sm-4" style="margin-top:.6em"> {{detalle.NumeroSerie}}</div>
                                    <div class="col-lg-3 col-md-3 col-sm-3" style="margin-top:.6em">{{detalle.Cantidad}}</div>
                                    <input type="text" maxlength="3" onKeypress="if (event.keyCode < 48 || event.keyCode > 57) event.returnValue = false;" ng-model="detalle.cantidadProxTradeIn" class="form-control col-lg-3 col-md-3 col-sm-3" style="width: 3.5em; margin-left: 3em; margin-bottom: .5em" />
                                </div>
                            </div>
                            <br>
                            <br>
                            <div class="col-sm-12 col-md-12 col-lg-12 form-group alert alert-info" style="margin-top: 2em;">
                                <p>
                                   Al dar click en <b>Continuar</b>, se agregarán al carrito de compras todos los productos que estén incluidos en el contrato con el estatus de <b>Aceptado</b>
                                </p>
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-12 col-lg-12 modal-footer">
                            <button type="button" class="btn btn-default btn-modal" data-dismiss="modal">Regresar</button>
                            <button type="button" class="btn btn-primary btn-modal" ng-click="solicitarRenovacionTradein();">Continuar</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal de Extencion -->
            <div id="extenderModal{{pedido.IdContrato}}" class="modal fade in" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="divLoading" data-cargando>
                        <div class=""><img src="images/ripple.svg" /></div>
                    </div>                
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close" ng-click="cerrarModal('extenderModal{{pedido.IdContrato}}')"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title"><b>Solicitud de extensión de contrato (co-term)</b></h4>
                        </div>
                        <div class="modal-body">
                            <p class="alert alert-info">
                                Las extenciones de contrato están destinadas a emparejar la fecha de término entre contratos de un usuario final. 
                                Podrá seleccionar entre las fechas fin de contratos que terminen en el futuro y estén registrados en clicksuscribe.
                              </p>
                            <div class="form-group has-feedback col-xs-7 col-sm-7 col-md-7 col-lg-7">
                            <h5><b>Selecciona la nueva fecha fin para el contrato:</b></h5>
                                <select id="NvaFechaFin" name="NvaFechaFin" class="form-control selectOption" ng-model="Extender.IdContrato" ng-options="OpcionExtencion.IdContrato as (OpcionExtencion.NumeroContrato + ' - ' + OpcionExtencion.FechaFin) for OpcionExtencion in OpcionesExtencion">
                                    <option ng-selected="true" value="">Selecciona una nueva fecha fin</option>
                                </select>
                            </div>
                            <br><br><br><br><hr>
                            <div class="form-group">
                                <h5><b>Nota:</b></h5>
                                <p>
                                  Al dar clic en <b>Extender contrato</b>, se agregarán al carrito de compras todos los productos que estén incluidos en el contrato con la cantidad actual de licencias activas</b>.
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal" style="padding: .8em 1.4em" ng-click="cerrarModal('extenderModal{{pedido.IdContrato}}')" ng-disabled="procesandoExtension">Regresar</button> 
                            <button type="button" class="btn btn-info" data-dismiss="modal" ng-click="solicitarExtension(pedido.IdContrato)" ng-disabled="procesandoExtension" style="padding: .8em 1.4em">{{procesandoExtensionLbl}}</button>
                        </div>
                    </div>
                </div>
            </div>
    
            <div id="noExtender" class="modal fade in" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close" ng-click="cerrarModal('noExtender')"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title"><b>Solicitud de extensión de contrato (co-term)</b></h4>
                        </div>
                        <div class="modal-body">
                            <p class="alert alert-info">
                                No es posible extender este contrato. No se encontraron contratos dentro de clicksuscribe que terminen en el futuro para el cliente seleccionado.
                              </p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal" style="padding: .8em 1.4em" ng-click="cerrarModal('noExtender')">Aceptar</button> 
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
